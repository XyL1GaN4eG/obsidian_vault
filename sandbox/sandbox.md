# Документация набора инструкций F32a (ISA)

F32a ISA - это стековый набор команд, разработанный для образовательных целей. В этом документе представлены инструкции F32a ISA, их синтаксис и семантика.

Комментарии в ассемблерном коде F32a обозначаются символом `\`.

Вдохновлено [F18a](https://www.greenarraychips.com/home/documents/greg/DB001-221113-F18a.pdf)

## Состояние процессора

- `A:dec`, `A:hex` -- Регистр A.
- `B:dec`, `B:hex` -- Регистр B.
- `T:dec`, `T:hex` -- Верхнее значение стека данных.
- `S:dec`, `S:hex` -- Второе значение в стеке данных.
- `R:dec`, `R:hex` -- Верхнее значение стека возврата.
- `stack:dec`, `stack:hex` -- Весь стек данных.
- `rstack:dec`, `rstack:hex` -- Весь стек возврата.
- `EAM` -- Режим расширенной арифметики (1 - включен, 0 - выключен).
- `C` -- Флаг переноса (1 - установлен, 0 - сброшен).

## Инструкции

Размер инструкции: 1 байт для кода операции, 4 байта для каждого аргумента.

### Режим расширенной арифметики (EAM)

Режим расширенной арифметики (EAM) позволяет выполнять сложение с учетом бита переноса. Подробности см. в инструкции `add`.

### Флаг переноса

Большинство инструкций сбрасывают флаг переноса. Исключения: `add`, `dup`.

### Инструкции работы с данными

- **Литерал**
    - **Синтаксис:** `lit <значение>`
    - **Описание:** Помещает непосредственное значение в стек данных.
    - **Операция:** `dataStack.push(<значение>)`

- **Чтение по адресу**
    - **Синтаксис:** `@p <адрес>`
    - **Описание:** Читает значение по указанному адресу и помещает его в стек данных.
    - **Операция:** `dataStack.push(mem[<адрес>])`

- **Чтение**
    - **Синтаксис:** `@`
    - **Описание:** Читает значение по адресу из регистра A и помещает его в стек данных.
    - **Операция:** `dataStack.push(mem[A])`

- **Чтение с инкрементом**
    - **Синтаксис:** `@+`
    - **Описание:** Читает значение по адресу из регистра A и помещает его в стек данных, затем увеличивает A.
    - **Операция:** `dataStack.push(mem[A]); A <- A + 1`

- **Чтение через B**
    - **Синтаксис:** `@b`
    - **Описание:** Читает значение по адресу из регистра B и помещает его в стек данных.
    - **Операция:** `dataStack.push(mem[B])`

- **Запись по адресу**
    - **Синтаксис:** `!p <адрес>`
    - **Описание:** Записывает верхнее значение стека данных по указанному адресу.
    - **Операция:** `mem[<адрес>] <- dataStack.pop()`

- **Запись**
    - **Синтаксис:** `!`
    - **Описание:** Записывает верхнее значение стека данных по адресу из регистра A.
    - **Операция:** `mem[A] <- dataStack.pop()`

- **Запись с инкрементом**
    - **Синтаксис:** `!+`
    - **Описание:** Записывает верхнее значение стека данных по адресу из регистра A и увеличивает A.
    - **Операция:** `mem[A] <- dataStack.pop(); A <- A + 1`

- **Запись через B**
    - **Синтаксис:** `!b`
    - **Описание:** Записывает верхнее значение стека данных по адресу из регистра B.
    - **Операция:** `mem[B] <- dataStack.pop()`

- **Запись в A**
    - **Синтаксис:** `a!`
    - **Описание:** Записывает верхнее значение стека данных в регистр A.
    - **Операция:** `A <- dataStack.pop()`

- **Запись в B**
    - **Синтаксис:** `b!`
    - **Описание:** Записывает верхнее значение стека данных в регистр B.
    - **Операция:** `B <- dataStack.pop()`

- **Чтение A**
    - **Синтаксис:** `a`
    - **Описание:** Помещает значение регистра A в стек данных.
    - **Операция:** `dataStack.push(A)`

### Арифметические инструкции

- **Сложение**
    - **Синтаксис:** `+`
    - **Описание:** Складывает два верхних значения в стеке данных.
    - **Операция (без EAM):** `dataStack.push(dataStack.pop() + dataStack.pop()), установка флага переноса`
    - **Операция (EAM):** `dataStack.push(dataStack.pop() + dataStack.pop() + перенос), установка флага переноса`

- **Шаг умножения**
    - **Синтаксис:** `+*`
    - **Описание:** Выполняет шаг умножения.
    - **Операция:** `T <- T + (если A[0] тогда S иначе 0); A <- A >> 1; если T[0] тогда A[31] <- 1 иначе A[31] <- 0; T <- T >> 1`

- **Шаг деления**
    - **Синтаксис:** `+/`
    - **Описание:** Выполняет шаг деления.
    - **Операция:** `остаток <- остаток << 1; если делимое[31] тогда остаток[0] <- 1; делимое <- делимое << 1; если остаток >= делитель тогда остаток <- остаток - делитель; частное <- частное << 1; если остаток >= делитель тогда частное[0] <- 1`

- **Сдвиг влево**
    - **Синтаксис:** `2*`
    - **Описание:** Сдвигает верхнее значение стека данных на один бит влево.
    - **Операция:** `dataStack.push(dataStack.pop() << 1)`

- **Сдвиг вправо**
    - **Синтаксис:** `2/`
    - **Описание:** Сдвигает верхнее значение стека данных на один бит вправо.
    - **Операция:** `dataStack.push(dataStack.pop() >> 1)`

- **Инверсия**
    - **Синтаксис:** `inv`
    - **Описание:** Инвертирует все биты верхнего значения в стеке данных.
    - **Операция:** `dataStack.push(~dataStack.pop())`

- **Установка режима арифметики**
    - **Синтаксис:** `eam`
    - **Описание:** Извлекает значение из стека данных и устанавливает флаг EAM.
    - **Операция:** `eam <- dataStack.pop()`

### Битовые операции

- **И**
    - **Синтаксис:** `and`
    - **Описание:** Побитовое И двух верхних значений стека данных.
    - **Операция:** `dataStack.push(dataStack.pop() & dataStack.pop())`

- **Исключающее ИЛИ**
    - **Синтаксис:** `xor`
    - **Описание:** Побитовое исключающее ИЛИ двух верхних значений стека данных.
    - **Операция:** `dataStack.push(dataStack.pop() ^ dataStack.pop())`

### Операции со стеком

- **Удаление**
    - **Синтаксис:** `drop`
    - **Описание:** Удаляет верхнее значение из стека данных.
    - **Операция:** `dataStack.pop()`

- **Дублирование**
    - **Синтаксис:** `dup`
    - **Описание:** Дублирует верхнее значение стека данных.
    - **Операция:** `dataStack.push(dataStack.top()), флаг переноса не изменяется`

- **Обмен**
    - **Синтаксис:** `over`
    - **Описание:** Меняет местами два верхних значения стека данных.
    - **Операция:** `T <- dataStack.pop(); S <- dataStack.pop(); dataStack.push(T); dataStack.push(S)`

### Инструкции управления потоком

- **Возврат**
    - **Синтаксис:** `;`
    - **Описание:** Возврат из подпрограммы.
    - **Операция:** `p <- returnStack.pop()`

- **Вызов**
    - **Синтаксис:** `<метка>`
    - **Описание:** Вызов подпрограммы по указанной метке.
    - **Операция:** `returnStack.push(p); p <- <метка>`

- **Переход**
    - **Синтаксис:** `<метка> ;`
    - **Описание:** Безусловный переход на метку.
    - **Операция:** `p <- <метка>`

- **Следующая итерация**
    - **Синтаксис:** `next <метка>`
    - **Описание:** Цикл с переходом на метку, декрементируя R.
    - **Операция:** `если R != 0 тогда R <- R - 1; p <- <метка>`

- **Условный переход (если ноль)**
    - **Синтаксис:** `if <метка>`
    - **Описание:** Переход на метку, если верхнее значение стека равно нулю.
    - **Операция:** `если dataStack.pop() == 0 тогда p <- <метка>`

- **Условный переход (если неотрицательное)**
    - **Синтаксис:** `-if <метка>`
    - **Описание:** Переход на метку, если верхнее значение стека неотрицательное.
    - **Операция:** `если dataStack.pop() >= 0 тогда p <- <метка>`

- **Останов**
    - **Синтаксис:** `halt`
    - **Описание:** Остановка процессора.

### Инструкции работы с регистрами

- **Из стека возврата в стек данных**
    - **Синтаксис:** `r>`
    - **Описание:** Переносит верхнее значение стека возврата в стек данных.
    - **Операция:** `dataStack.push(returnStack.pop())`

- **Из стека данных в стек возврата**
    - **Синтаксис:** `>r`
    - **Описание:** Переносит верхнее значение стека данных в стек возврата.
    - **Операция:** `returnStack.push(dataStack.pop())